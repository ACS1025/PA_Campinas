<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="src/img/kmd-16x16.png" type="image/png">
<title>Confirma√ß√£o de escolta</title>

<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f7f7f7;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding-top: 60px;
    background-image: url('src/img/Registro de Saidas.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.container {
    background: #fff;
    padding: 20px;
    max-width: 1000px;
    margin: 0 auto;
    width: 100%;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    border-radius: 8px;
}

h1 { text-align: center; color: #333; margin-bottom: 10px; }
.greeting { font-size: 18px; text-align: center; margin-bottom: 15px; }

.form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 25px;
}

@media (max-width: 992px) {
    .form-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 600px) {
    .form-grid { grid-template-columns: 1fr; }
}

.form-group { min-width: 180px; }
label { display: block; font-weight: bold; color: #555; }

input[type="text"], select, textarea, input[type="datetime-local"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
    box-sizing: border-box;
}

.full-width { grid-column: 1 / -1; }

#distanciaBox {
    grid-column: 1 / -1;
    padding: 12px;
    border-radius: 6px;
    font-weight: bold;
    text-align: center;
    display: none;
}

.navbar {
    display: flex;
    justify-content: center;
    background-color: #444;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1000;
}

.navbar a {
    color: white;
    padding: 14px 20px;
    text-decoration: none;
}

.navbar a:hover { background-color: #555; }

button {
    background-color: #007bff;
    color: #fff;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
    grid-column: 1 / -1;
}
button:hover { background-color: #0056b3; }
</style>
</head>

<body>

<div class="navbar">
    <a href="index.html">Home</a>
    <a href="registro-saidas.html">Registro de sa√≠das</a>
    <a href="solicitacao-escolta.html">Solicita√ß√£o de escolta</a>
    <a href="conhecimento.html" class="active">Para conhecimento</a>
    <a href="convite.html">Convite Motorista</a>
    <a href="videos.html">Galeria de v√≠deos</a>
    <a href="brief.html">Briefing</a>
    <a href="posicao.html">Posi√ß√£o escolta</a>
</div>

<div class="container">
<h1>Posi√ß√£o para a escolta</h1>
<div class="greeting"><span id="greetingMessage"></span></div>

<form id="formOcorrencia">
<div class="form-grid">

<div class="form-group">
<label>Data/Hora</label>
<input type="datetime-local" id="dataHora" readonly>
</div>

<div class="form-group">
<label>Ordem</label>
<select id="ordem">
<option value="Selecione">Selecione</option>
<option value="CPQ x BEL">CPQ x BEL</option>
<option value="CPQ x CAJ">CPQ x CAJ</option>
<option value="BEL X CPQ">BEL X CPQ</option>
<option value="BEL X CAJ">BEL X CAJ</option>
</select>
</div>

<div class="form-group">
<label>Motorista</label>
<input type="text" id="motorista">
</div>

<div class="form-group">
<label>Ve√≠culo</label>
<input type="text" id="veiculo">
</div>

<div class="form-group">
<label>Manifesto</label>
<input type="text" id="manifesto">
</div>

<div class="form-group">
<label>Km destino</label>
<select id="km">
<option value="ORIGEM">ORIGEM</option>
<option value="100">100</option>
<option value="150">150</option>
<option value="250">250</option>
</select>
</div>

<div class="form-group">
<label>Rota</label>
<input type="text" id="rota">
</div>

<div class="form-group">
<label>Cliente</label>
<input type="text" id="cliente">
</div>

<div class="form-group">
<label>√öltima Posi√ß√£o</label>
<input type="text" id="ultimaPosicao">
</div>

<div class="form-group">
<label>Lat/Long Ve√≠culo</label>
<input type="text" id="latLong" placeholder="-18.090830, -49.271110">
</div>

<div class="form-group">
<label>Lat/Long Ponto Encontro</label>
<input type="text" id="latLongEncontro" placeholder="-21.123456, -47.123456">
</div>

<div id="distanciaBox"></div>

<div class="form-group full-width">
<label>Link Google Maps</label>
<textarea id="link" rows="2"></textarea>
</div>

<div class="form-group full-width">
<label>Ponto de Encontro</label>
<select id="pontoSelect">
    <option value="">Selecione</option>
    <option value="-21.640200,-47.754300|Auto Posto Gironda, SP-253, 1 - Gironda, Lu√≠s Ant√¥nio - SP">
        Auto Posto Gironda - SP
    </option>
    <option value="-22.903500,-47.061600|Cajamar - Centro">
        Cajamar - Centro
    </option>
</select>
</div>

<div class="form-group full-width">
<label>Endere√ßo do Ponto de Encontro</label>
<input type="text" id="postoApoio" readonly>
</div>


<button type="button" id="btnEnviar" onclick="enviarTudo()">Enviar</button>

</div>
</form>
</div>

<script>
const hour = new Date().getHours();
const greeting = hour < 12 ? "Bom dia!" : hour < 18 ? "Boa tarde!" : "Boa noite!";
document.getElementById("greetingMessage").textContent = greeting;

const agora = new Date();
agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
document.getElementById("dataHora").value = agora.toISOString().slice(0, 16);

let distanciaCalculada = 0; // ‚úÖ vari√°vel global segura

function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

document.getElementById("pontoSelect").addEventListener("change", function () {
    const select = this.value;
    if (!select) return;

    const partes = select.split("|");
    const coords = partes[0];
    const endereco = partes[1];

    document.getElementById("latLongEncontro").value = coords;
    document.getElementById("postoApoio").value = endereco;

    atualizarDistancia();
});

function atualizarDistancia() {
    const box = document.getElementById("distanciaBox");

    try {
        const latLongValue = document.getElementById("latLong").value;
        const latLongEncontroValue = document.getElementById("latLongEncontro").value;

        const [lat1, lon1] = latLongValue.split(',').map(v => parseFloat(v.trim()));
        const [lat2, lon2] = latLongEncontroValue.split(',').map(v => parseFloat(v.trim()));

        if (!isNaN(lat1) && !isNaN(lon1) && !isNaN(lat2) && !isNaN(lon2)) {

            const distancia = calcularDistancia(lat1, lon1, lat2, lon2);
            const km = Math.round(distancia);

            distanciaCalculada = km; // ‚úÖ GUARDA DIST√ÇNCIA REAL

            const tempo = (distancia / 80).toFixed(1);

            let status = "";
            let cor = "";

            if (km <= 150) {
                status = "üü¢ PR√ìXIMO";
                cor = "#d4edda";
            } 
            else if (km <= 500) {
                status = "üü° M√âDIO";
                cor = "#fff3cd";
            } 
            else {
                status = "üî¥ LONGE";
                cor = "#f8d7da";
            }

            box.style.display = "block";
            box.style.background = cor;
            box.innerHTML = `
                <strong>${status}</strong><br>
                üöõ Ve√≠culo a <strong>${km} km</strong> do ponto de encontro<br>
                ‚è± ETA aproximado: ${tempo}h
            `;

        } else {
            box.style.display = "none";
            distanciaCalculada = 0;
        }
    } catch (e) {
        box.style.display = "none";
        distanciaCalculada = 0;
    }
}

document.getElementById("latLong").addEventListener("input", atualizarDistancia);
document.getElementById("latLongEncontro").addEventListener("input", atualizarDistancia);

function enviarTudo() {

const btn = document.getElementById("btnEnviar");
btn.disabled = true;
btn.textContent = "Gravando...";

const rawData = dataHora.value;
const [data, hora] = rawData.split('T');
const [ano, mes, dia] = data.split('-');
const dataBrasil = `${dia}/${mes}/${ano} ${hora}`;

let distanciaFinal = distanciaCalculada > 0 ? distanciaCalculada : "";

const dados = {
    dataHora: dataBrasil,
    ordem: ordem.value,
    motorista: motorista.value,
    veiculo: veiculo.value,
    manifesto: manifesto.value,
    kmDestino: km.value,
    rota: rota.value,
    cliente: cliente.value,
    ultimaPosicao: ultimaPosicao.value,
    latLong: latLong.value,
    latLongEncontro: latLongEncontro.value,
    distanciaKM: distanciaFinal,
    linkGoogle: link.value,
    postoApoio: postoApoio.value
};

fetch("https://script.google.com/macros/s/AKfycby8K31knAtp3H4U7jYk0Mb66wX7FqPQBgX4_7ZLHQ_2ujfip5hYHT56gnQ_A_IY58G_/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(dados)
})
.then(() => {

const msg = `*Posi√ß√£o para Escolta*\n\n${greeting}\n\n` +
(distanciaFinal ? `üöõ *Ve√≠culo a ${distanciaFinal} km do ponto de encontro*\n\n` : "") +
`*Data/Hora:* ${dados.dataHora}\n` +
`*Ordem:* ${dados.ordem}\n` +
`*Motorista:* ${dados.motorista}\n` +
`*Ve√≠culo:* ${dados.veiculo}\n` +
`*Manifesto:* ${dados.manifesto}\n` +
`*KM Destino:* ${dados.kmDestino}\n` +
`*Rota:* ${dados.rota}\n` +
`*Cliente:* ${dados.cliente}\n` +
`*√öltima Posi√ß√£o:* ${dados.ultimaPosicao}\n` +
`*Lat/Long:* ${dados.latLong}\n\n` +
`üìç *Link Mapa:* ${dados.linkGoogle}\n\n` +
`*Ponto de Encontro:* ${dados.postoApoio}`;

window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");

btn.disabled = false;
btn.textContent = "Enviar";
alert("Dados enviados com sucesso!");

})
.catch(() => {
alert("Erro ao salvar dados.");
btn.disabled = false;
btn.textContent = "Enviar";
});

}
</script>


</body>
</html>
