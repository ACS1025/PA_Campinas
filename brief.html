<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <base target="_top">
  <title>Enviar Briefing</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-image: url("src/img/Registro de Saidas.png"); background-size: cover; background-position: center; background-attachment: fixed; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; margin-top: 70px; color: white; }
    .container { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.2); border-radius:15px; padding:40px; max-width:900px; width:100%; box-shadow:0 8px 32px rgba(31,38,135,0.37); }
    h3 { margin-top:0; color:#031876; text-align:center; margin-bottom:30px; font-size:28px; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
    label { display:block; margin-top:10px; font-weight:600; color:#031876; text-shadow:1px 1px 2px rgba(0,0,0,0.2); }
    input, select, textarea { width:100%; padding:10px; box-sizing:border-box; margin-top:6px; border:1px solid rgba(255,255,255,0.3); border-radius:8px; background:rgba(248, 247, 247, 0.95); font-family:Arial,sans-serif; font-size:14px; transition: all 0.3s ease; color: #333; }
    input:focus, select:focus, textarea:focus { outline:none; background:rgb(246, 245, 245); border-color:rgba(255,255,255,0.8); box-shadow:0 0 10px rgba(242, 240, 240, 0.3); }
    textarea[readonly] { background: rgba(240,240,240,0.95); color: #666; cursor: default; }
    nav { width:100%; background-color: rgba(68,68,68,0.95); padding:15px 0; position:fixed; top:0; left:0; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,0.3); }
    nav ul { list-style:none; padding:0; text-align:center; margin:0; display:flex; justify-content:center; gap:20px; flex-wrap:wrap; }
    nav ul li { display:inline-block; }
    nav ul li a { color: #dceff8; text-decoration:none; font-size:16px; padding:10px 18px; border-radius:5px; transition: background-color 0.3s ease; }
    nav ul li a:hover { background-color: rgba(23,23,175,0.44); }
    nav ul li a.active { background-color: rgba(23,23,175,0.7); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 220px; min-width:160px; }
    .full-width { flex: 1 1 100%; }
    button { margin-top:20px; padding:12px 20px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; transition: all 0.3s ease; text-shadow:1px 1px 2px rgba(0,0,0,0.3); box-shadow:0 4px 15px rgba(0,0,0,0.2); width:100%; }
    button:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,0.3); }
    button:active { transform:translateY(0); }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .btn-secondary { background:linear-gradient(135deg,#17a2b8 0%,#138496 100%); margin-top:10px; }
    .link { margin-top:20px; background:rgba(255,255,255,0.15); padding:15px; border-radius:8px; word-break:break-all; border:1px solid rgba(255,255,255,0.3); color:#fbf7f7; }
    .link a { color:#ffd700; text-decoration:none; font-weight:bold; }
    .link a:hover { text-decoration:underline; }
    .link.success { background: rgba(76,175,80,0.2); border-color: rgba(76,175,80,0.5); }
    .link.error { background: rgba(244,67,54,0.2); border-color: rgba(244,67,54,0.5); }
    .input-box { position: relative; }
    ul.autocomplete-list { position:absolute; z-index:999; left:0; right:0; max-height:160px; overflow:auto; background:rgba(251, 249, 249, 0.95); border:1px solid rgba(255,255,255,0.3); list-style:none; margin:0; padding:0; border-radius:8px; margin-top:2px; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
    ul.autocomplete-list li { padding:10px; cursor:pointer; color:#333; border-bottom:1px solid rgba(0,0,0,0.1); }
    ul.autocomplete-list li:last-child { border-bottom:none; }
    ul.autocomplete-list li:hover { background: rgba(102,126,234,0.2); color:#667eea; }
    .template-section { background: rgba(255,255,255,0.08); padding:15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); margin:15px 0; }
    .template-buttons { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .template-btn { flex:1; min-width:120px; padding:8px 12px; background:rgba(236, 213, 6, 0.2); color:rgb(245, 8, 8); border:1px solid rgba(255,255,255,0.4); border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold; transition:all 0.3s ease; }
    .template-btn:hover { background:rgba(255,255,255,0.3); border-color:rgba(255,255,255,0.6); }
    #resultado { margin-top:20px; min-height:40px; }
    @media(max-width:768px) { body{margin-top:120px;} .container{padding:20px;} h3{font-size:22px; margin-bottom:20px;} .row{flex-direction:column;} .col{flex:1 1 100%;} nav ul{gap:10px;} nav ul li a{font-size:14px; padding:8px 12px;} .template-buttons{flex-direction:column;} .template-btn{min-width:auto;} }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="registro-saidas.html">Registro de Sa√≠das</a></li>
      <li><a href="solicitacao-escolta.html">Solicita√ß√£o de Escolta</a></li>
      <li><a href="conhecimento.html">Para conhecimento</a></li>
      <li><a href="convite.html">Convite Motorista</a></li>
      <li><a href="brief.html" class="active">Briefing</a></li>
    </ul>
  </nav>

  <div class="container">
    <h3>Enviar Briefing via WhatsApp</h3>
    <div>
      <label>C√≥digo SM *<input id="sm" name="sm" placeholder="Ex: 1175983" required/></label>
      <label>Embarcador<input id="embarcador" name="embarcador"/></label>
      <label>Transportador<input id="transportador" name="transportador"/></label>
      <label>Equipamento<input id="equipamento" name="equipamento"/></label>

      <div class="row">
        <div class="col input-box">
          <label>Motorista *</label>
          <input id="motorista" name="motorista" placeholder="Digite o nome (autocomplete)" required/>
          <ul id="lista-motorista" class="autocomplete-list" style="display:none"></ul>
        </div>
        <div class="col input-box">
          <label>Placa Cavalo</label>
          <input id="placa_cavalo" name="placa_cavalo" placeholder="Ex: GHI-6088"/>
          <ul id="lista-placa" class="autocomplete-list" style="display:none"></ul>
        </div>
        <div class="col input-box">
          <label>Placa Carreta</label>
          <input id="placa_carreta" name="placa_carreta" placeholder="Ex: CWI-2880"/>
          <ul id="lista-carreta" class="autocomplete-list" style="display:none"></ul>
        </div>
        <div class="col">
          <label>Cliente</label>
          <input id="cliente" name="cliente"/>
        </div>
      </div>

      <label>Rota<input id="rota" name="rota" placeholder="Ex: Campinas/SP X Rio de Janeiro/RJ"/></label>

      <!-- Modelos de Texto -->
      <div class="template-section full-width">
        <label>üìã Modelos de Mensagem:</label>
        <div class="template-buttons">
                    
          <button type="button" class="template-btn" onclick="inserirTemplate('briefing')">üìç Briefing</button>
          <button type="button" class="template-btn" onclick="inserirTemplate('reciclagem')">‚ôªÔ∏è Reciclagem</button>
          <button type="button" class="template-btn" onclick="inserirTemplate('fotos')">üì∏ Fotos</button>
        </div>
      </div>

      <!-- Texto Pronto -->
      <div class="full-width">
        <label for="textoPronto">Mensagem para WhatsApp:</label>
        <textarea id="textoPronto" name="textoPronto" rows="6" readonly></textarea>
      </div>

      <!-- Bot√µes de A√ß√£o -->                        
        <div class="col">
          <button id="btnEnviar">üì± Enviar via WhatsApp</button>
        </div>
      </div>
      <div id="resultado"></div>
    </div>
  </div>

  <script>
    // ===================================================================
    // MODELOS DE TEXTO PREDEFINIDOS
    // ===================================================================
    const textos = {
        
      reciclagem: `*Reciclagem Obrigat√≥ria*\n\nSr. Motorista.\n\nSeu checklist est√° suspenso para novas viagens. Ser√° necess√°rio reciclagem com a equipe Komando para valid√°-lo no sistema. Por favor, preencha os dados no formul√°rio e compare√ßa na unidade em hor√°rio comercial.\n\nhttps://forms.gle/tt4LVq24EjBsVC7WA\n\nQualquer d√∫vida pode nos chamar.\n\n*Equipe Komando*`,
      
      briefing: `*Viagem Monitorada*\n\nSr. Motorista.\n\nVoc√™ tem uma viagem programada que ser√° monitorada pela Komando. Por favor, acesse o briefing de viagem no link.\n\nhttps://shre.ink/briefingkomando \n\nQualquer d√∫vida pode nos chamar.\n\n*Equipe Komando*`,
      
      fotos: `*Confirma√ß√£o de Parada/Pernoite*\n\nSr. Motorista.\n\nAo informar paradas e pernoite via macro, por favor confirme a a√ß√£o em nosso WhatsApp: *(19 98103-2053)*\n\n√â preciso que voc√™ nos envie:\n\n*‚Üí FOTO DO BA√ö*\n*‚Üí FOTO DOS LACRES*\n*‚Üí FOTO DO ENGATE*\n\nEste procedimento de envio dever√° ser repetido quando voc√™ reiniciar a viagem tamb√©m.\n\nQualquer d√∫vida pode nos chamar.\n\n*Equipe Komando*`
    };

    // endpoint do Apps Script (substitua pela sua URL se necess√°rio)
    const endpointBase = "https://script.google.com/macros/s/AKfycbxiux1H7NSCSXlQsRIJ24QPFl_uf2bNNzEeVh4VUlC7Oe6w733uQ8YQ_v-6z2YQibJ2/exec";
    let listaNomes=[], listaPlacas=[], listaCarretas=[];

    // ===================================================================
    // FUN√á√ïES UTILIT√ÅRIAS
    // ===================================================================
    function showMessage(msg, type='success'){ 
      const resultado = document.getElementById('resultado');
      if(resultado) {
        resultado.innerHTML = '<div class="link '+type+'">'+msg+'</div>';
      }
    }

    // ===================================================================
    // INSERE MODELO DE TEXTO
    // ===================================================================
    function inserirTemplate(tipo){
      const textoPronto = document.getElementById('textoPronto');
      if(textoPronto && textos[tipo]){
        textoPronto.value = textos[tipo];
        showMessage('‚úÖ Modelo inserido com sucesso!', 'success');
      }
    }

    // ===================================================================
    // GERA MENSAGEM AUTOMATICAMENTE
    // ===================================================================
    function atualizarMensagem(){
      const sm = (document.getElementById('sm')?.value || '').trim();
      const embarcador = (document.getElementById('embarcador')?.value || '').trim();
      const transportador = (document.getElementById('transportador')?.value || '').trim();
      const equipamento = (document.getElementById('equipamento')?.value || '').trim();
      const motorista = (document.getElementById('motorista')?.value || '').trim();
      const placaCavalo = (document.getElementById('placa_cavalo')?.value || '').trim();
      const placaCarreta = (document.getElementById('placa_carreta')?.value || '').trim();
      const rota = (document.getElementById('rota')?.value || '').trim();
      const cliente = (document.getElementById('cliente')?.value || '').trim();

      let mensagem = '';

      if(sm) mensagem += `*SM:* ${sm}\n`;
      if(motorista) mensagem += `*Motorista:* ${motorista}\n`;
      if(embarcador) mensagem += `*Embarcador:* ${embarcador}\n`;
      if(transportador) mensagem += `*Transportador:* ${transportador}\n`;
      if(equipamento) mensagem += `*Equipamento:* ${equipamento}\n`;
      if(placaCavalo) mensagem += `*Placa Cavalo:* ${placaCavalo}\n`;
      if(placaCarreta) mensagem += `*Placa Carreta:* ${placaCarreta}\n`;
      if(cliente) mensagem += `*Cliente:* ${cliente}\n`;
      if(rota) mensagem += `*Rota:* ${rota}\n`;

      document.getElementById('textoPronto').value = mensagem;
    }

    // ===================================================================
    // MONTA PAYLOAD PARA PLANILHA
    // ===================================================================
    function montarPayloadParaPlanilha(){
      const now = new Date();
      return {
        data_envio: now.toISOString(),
        codigo_sm: (document.getElementById('sm')?.value || '').trim(),
        embarcador: (document.getElementById('embarcador')?.value || '').trim(),
        transportador: (document.getElementById('transportador')?.value || '').trim(),
        equipamento: (document.getElementById('equipamento')?.value || '').trim(),
        motorista: (document.getElementById('motorista')?.value || '').trim(),
        placa_cavalo: (document.getElementById('placa_cavalo')?.value || '').trim(),
        placa_carreta: (document.getElementById('placa_carreta')?.value || '').trim(),
        rota: (document.getElementById('rota')?.value || '').trim(),
        cliente: (document.getElementById('cliente')?.value || '').trim(),
        texto_pronto: (document.getElementById('textoPronto')?.value || '').trim()
      };
    }

    // ===================================================================
    // ENVIA DADOS PARA O APPS SCRIPT (GOOGLE SHEETS) - COM FALLBACK
    // ===================================================================
    async function enviarParaPlanilha(payload){
      // Tentativa 1: POST com JSON (padr√£o)
      try {
        console.log('üì§ Tentativa 1: POST JSON...');
        const resp = await fetch(endpointBase, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'save', data: payload })
        });
        
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const json = await resp.json();
        console.log('‚úÖ Sucesso:', json);
        return json;
      } catch(err1){
        console.warn('‚ö†Ô∏è JSON falhou:', err1.message);
        
        // Tentativa 2: Form URL-encoded (evita CORS preflight)
        try {
          console.log('üì§ Tentativa 2: Form URL-encoded...');
          const formData = new URLSearchParams();
          formData.append('action', 'save');
          formData.append('data', JSON.stringify(payload));
          
          const resp = await fetch(endpointBase, {
            method: 'POST',
            body: formData
          });
          
          if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const json = await resp.json();
          console.log('‚úÖ Sucesso com Form:', json);
          return json;
        } catch(err2){
          console.error('‚ùå Ambas as tentativas falharam');
          throw new Error('Erro de conex√£o - Apps Script pode estar offline ou URL incorreta');
        }
      }
    }

    // ===================================================================
    // CARREGA LISTAS DO SERVIDOR
    // ===================================================================
    async function loadList(tipo){
      try{
        const resp = await fetch(`${endpointBase}?list=${tipo}`, {
          headers: { 'Accept': 'application/json' }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const json = await resp.json();
        return Array.isArray(json) ? json : [];
      }catch(e){ 
        console.error(`Erro ao carregar ${tipo}:`, e);
        return []; 
      }
    }

    // Inicializa listas ao carregar p√°gina
    (async function initLists(){
      try {
        listaNomes = await loadList('motoristas');
        console.log('‚úì Motoristas:', listaNomes.length);
        
        listaPlacas = await loadList('placas');
        console.log('‚úì Placas:', listaPlacas.length);
        
        listaCarretas = await loadList('carretas');
        console.log('‚úì Carretas:', listaCarretas.length);
      } catch(e) {
        console.error('Erro ao carregar listas:', e);
      }
    })();

    // ===================================================================
    // AUTOCOMPLETE
    // ===================================================================
    function showList(containerId, items){
      const ul = document.getElementById(containerId);
      if(!ul) return;
      
      ul.innerHTML='';
      if(!items || !items.length){ 
        ul.style.display='none'; 
        return;
      }
      
      items.forEach(it => { 
        const li = document.createElement('li'); 
        li.textContent = it; 
        li.onclick = () => {
          const inputId = containerId.replace('lista-','');
          const inputEl = document.getElementById(inputId);
          if(inputEl) inputEl.value = it;
          ul.innerHTML = ''; 
          ul.style.display = 'none';
          atualizarMensagem();
        }; 
        ul.appendChild(li); 
      });
      
      ul.style.display='block';
    }

    // Event listeners para autocomplete
    const motoristaInput = document.getElementById('motorista');
    if(motoristaInput) {
      motoristaInput.addEventListener('input', function(){
        const v = this.value.trim();
        const matches = v ? listaNomes.filter(n => n.toLowerCase().startsWith(v.toLowerCase())).slice(0,30) : [];
        showList('lista-motorista', matches);
        atualizarMensagem();
      });
    }

    const placaCavaloInput = document.getElementById('placa_cavalo');
    if(placaCavaloInput) {
      placaCavaloInput.addEventListener('input', function(){
        const v = this.value.trim();
        const matches = v ? listaPlacas.filter(p => p.toLowerCase().startsWith(v.toLowerCase())).slice(0,30) : [];
        showList('lista-placa', matches);
        atualizarMensagem();
      });
    }

    const placaCarretaInput = document.getElementById('placa_carreta');
    if(placaCarretaInput) {
      placaCarretaInput.addEventListener('input', function(){
        const v = this.value.trim();
        const matches = v ? listaCarretas.filter(p => p.toLowerCase().startsWith(v.toLowerCase())).slice(0,30) : [];
        showList('lista-carreta', matches);
        atualizarMensagem();
      });
    }

    // Atualiza mensagem ao modificar campos
    const camposAtualizaveis = ['sm', 'embarcador', 'transportador', 'equipamento', 'rota', 'cliente'];
    camposAtualizaveis.forEach(id => {
      const el = document.getElementById(id);
      if(el) {
        el.addEventListener('input', atualizarMensagem);
        el.addEventListener('change', atualizarMensagem);
      }
    });

    // ===================================================================
    // EVENTO DO BOT√ÉO ENVIAR VIA WHATSAPP
    // ===================================================================
    const btnEnviar = document.getElementById('btnEnviar');
    if(btnEnviar) {
      btnEnviar.addEventListener('click', async function(e){
        e.preventDefault();
        const sm = (document.getElementById('sm')?.value || '').trim();
        const motorista = (document.getElementById('motorista')?.value || '').trim();
        const mensagem = (document.getElementById('textoPronto')?.value || '').trim();

        if(!sm){ showMessage('‚ùå Preencha o C√≥digo SM', 'error'); return; }
        if(!motorista){ showMessage('‚ùå Preencha o Motorista', 'error'); return; }
        if(!mensagem){ showMessage('‚ùå Preencha a mensagem', 'error'); return; }

        const payload = montarPayloadParaPlanilha();
        btnEnviar.disabled = true;
        showMessage('‚è≥ Enviando para planilha...', 'success');

        try {
          const res = await enviarParaPlanilha(payload);
          if(res && (res.ok || res.result === 'success')) {
            showMessage('‚úÖ Dados enviados para a planilha com sucesso!', 'success');
            try { window.open('https://wa.me/?text=' + encodeURIComponent(mensagem), '_blank'); } catch(e){ /* popup bloqueado */ }
          } else {
            showMessage('‚ùå Erro ao salvar: ' + (res?.error || JSON.stringify(res)), 'error');
          }
        } catch(err) {
          showMessage('‚ùå Erro de conex√£o. Verifique o Apps Script / CORS.', 'error');
        } finally {
          btnEnviar.disabled = false;
        }
      });
    }
  </script>
</body>
</html>
