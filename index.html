<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="src/img/kmd-16x16.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <title>PA-Campinas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-image: url('src/img/background.jpg'); /* Inclua o caminho da imagem de fundo */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
        }

        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.6); /* Fundo escuro com opacidade */
            border-radius: 10px;
            margin: 20px;
        }

        .dashboard-card {
            flex: 1 1 calc(30% - 40px); /* Cada cartão ocupa 30% da largura */
            margin: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.9); /* Fundo claro com opacidade */
            text-align: center;
            color: #333;
        }

        #chartContainer {
            width: 100%;
            height: 400px;
        }

        @media (max-width: 768px) {
            .dashboard-card {
                flex: 1 1 calc(50% - 40px); /* Reduz para 50% em telas menores */
            }
        }

        @media (max-width: 480px) {
            .dashboard-card {
                flex: 1 1 100%; /* Cada cartão ocupa 100% da largura em telas muito pequenas */
            }
        }

        .error-message {
            color: red;
            text-align: center;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f1f1f1;
        }

        .header {
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
        }

        .navbar {
            display: flex;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
        }

        .navbar a {
            color: white;
            padding: 14px 20px;
            text-decoration: none;
            text-align: center;
            background-color: transparent;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .navbar a:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        footer {
            text-align: center;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            position: fixed;
            width: 100%;
            bottom: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>PA-Campinas</h1>
    </div>

    <div class="navbar">
        <a href="index.html" class="active">Home</a>
        <a href="registro-saidas.html">Registro de Saídas</a>
        <a href="solicitacao-escolta.html">Solicitação de Escolta</a>
    </div>

    <div class="content">
        <div class="dashboard">
            <!-- Cartões do dashboard -->
            <div class="dashboard-card" id="solicitacao-card">
                <h3>Solicitação de Escolta</h3>
                <p>Total: <span id="total-solicitacoes">0</span></p>
            </div>
            <div class="dashboard-card" id="distancia-card">
                <h3>Total por Distância</h3>
                <div id="chartContainer"></div> <!-- Gráfico de coluna -->
            </div>
            <div class="dashboard-card" id="lista-card">
                <h3>Placas e Ponto de Encontro</h3>
                <ul id="lista"></ul> <!-- Lista filtrada -->
            </div>
        </div>
        
        <div class="error-message" id="error-message"></div> <!-- Área para mensagens de erro -->
    </div>

    <footer>
        <p>&copy; 2024 PA-Campinas. Todos os direitos reservados.</p>
    </footer>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        function initClient() {
            gapi.client.init({
                apiKey: 'YOUR_API_KEY', // Coloque sua chave de API aqui
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            }).then(function () {
                return gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: 'YOUR_SPREADSHEET_ID', // Substitua pelo ID da sua planilha
                    range: 'PONTO DE ENCONTRO!A1:R1000', // Altere para o intervalo que você deseja buscar
                });
            }).then(function (response) {
                const data = response.result.values;
                const totalSolicitacoesEl = document.getElementById('total-solicitacoes');
                const errorMessage = document.getElementById('error-message');
                const lista = document.getElementById('lista');
                const chartContainer = document.getElementById('chartContainer');
                errorMessage.innerHTML = ''; // Limpa mensagens de erro
                chartContainer.innerHTML = ''; // Limpa o gráfico anterior

                if (data.length) {
                    // Inicializando variáveis
                    let totalSolicitacoes = 0;
                    const distancias = {};
                    const filteredList = [];

                    // Processa os dados
                    data.slice(1).forEach(row => {
                        if (row[15] && ['SE:FIM DE OPERAÇÃO', 'SOLICITAÇÃO DE ESCOLTA EM ABERTO', 'CONFIRMADO', 'ESCOLTA EM ANDAMENTO', 'NÃO CONFIRMADO'].includes(row[15])) {
                            totalSolicitacoes += 1;

                            const distancia = parseInt(row[2] || 0);
                            if (distancias[distancia]) {
                                distancias[distancia] += 1;
                            } else {
                                distancias[distancia] = 1;
                            }

                            // Filtro para lista
                            filteredList.push({
                                placa: row[9],
                                distancia: row[3],
                                pontoEncontro: row[7],
                                cliente: row[8],
                            });
                        }
                    });

                    // Atualiza o total de solicitações
                    totalSolicitacoesEl.innerHTML = totalSolicitacoes;

                    // Preparar pontos de dados para o gráfico
                    const dataPoints = Object.keys(distancias).map(distancia => {
                        return { y: distancias[distancia], label: `${distancia} Km` };
                    });

                    // Criar o gráfico de coluna
                    const chart = new CanvasJS.Chart("chartContainer", {
                        animationEnabled: true,
                        theme: "light2",
                        title: {
                            text: "Total de Solicitações por Distância"
                        },
                        axisY: {
                            title: "Total de Solicitações"
                        },
                        data: [{
                            type: "column",
                            dataPoints: dataPoints
                        }]
                    });
                    chart.render();

                    // Exibir a lista filtrada
                    lista.innerHTML = filteredList.map(item => {
                        return `<li>Placa: ${item.placa}, Distância: ${item.distancia} Km, Ponto de Encontro: ${item.pontoEncontro}, Cliente: ${item.cliente}</li>`;
                    }).join('');
                } else {
                    errorMessage.innerHTML = "Nenhum dado encontrado.";
                }
            }, function (response) {
                const errorMessage = document.getElementById('error-message');
                errorMessage.innerHTML = "Erro ao acessar a planilha: " + response.result.error.message;
            });
        }

        function handleClientLoad() {
            gapi.load('client', initClient);
        }

        document.addEventListener("DOMContentLoaded", handleClientLoad);
    </script>
</body>
</html>
